<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|monospace:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css">


  <meta name="keywords" content="web前端、前端工程师">








  <link rel="shortcut icon" type="image/x-icon" href="/Images/favicon.ico?v=5.1.1">






<meta name="description" content="前言：  在同样的网络环境下，两个同样能满足你的需求的网站，一个“Duang”的一下就加载出来了，一个纠结了半天才出来，你会选择哪个？研究表明：用户最满意的打开网页时间是2-5秒，如果等待超过10秒，99%的用户会关闭这个网页。也许这样讲，各位还不会有太多感触，接下来我列举一组数据：Google 网站访问速度每慢400ms就导致用户搜索请 求下降0.59%; Amazon 每增加100ms网站延迟">
<meta property="og:type" content="article">
<meta property="og:title" content="Web前端性能优化——提高页面加载速度">
<meta property="og:url" content="http://spumpkin.github.io/2018/11/18/Web前端性能优化——提高页面加载速度/index.html">
<meta property="og:site_name" content="Spumpkin&#39;s blog">
<meta property="og:description" content="前言：  在同样的网络环境下，两个同样能满足你的需求的网站，一个“Duang”的一下就加载出来了，一个纠结了半天才出来，你会选择哪个？研究表明：用户最满意的打开网页时间是2-5秒，如果等待超过10秒，99%的用户会关闭这个网页。也许这样讲，各位还不会有太多感触，接下来我列举一组数据：Google 网站访问速度每慢400ms就导致用户搜索请 求下降0.59%; Amazon 每增加100ms网站延迟">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/861963/201603/861963-20160317164616318-1916945778.png">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/861963/201603/861963-20160317164616318-1916945778.png">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/861963/201603/861963-20160319143807209-1678450570.png">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/861963/201603/861963-20160319143556756-1561871554.png">
<meta property="og:updated_time" content="2018-11-19T16:23:54.027Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Web前端性能优化——提高页面加载速度">
<meta name="twitter:description" content="前言：  在同样的网络环境下，两个同样能满足你的需求的网站，一个“Duang”的一下就加载出来了，一个纠结了半天才出来，你会选择哪个？研究表明：用户最满意的打开网页时间是2-5秒，如果等待超过10秒，99%的用户会关闭这个网页。也许这样讲，各位还不会有太多感触，接下来我列举一组数据：Google 网站访问速度每慢400ms就导致用户搜索请 求下降0.59%; Amazon 每增加100ms网站延迟">
<meta name="twitter:image" content="https://images2015.cnblogs.com/blog/861963/201603/861963-20160317164616318-1916945778.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://spumpkin.github.io/2018/11/18/Web前端性能优化——提高页面加载速度/">





  <title>Web前端性能优化——提高页面加载速度 | Spumpkin's blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?51393b20fed55da5e73d0255cf2eebcc";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Spumpkin's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">努力搬砖</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://spumpkin.github.io/2018/11/18/Web前端性能优化——提高页面加载速度/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Spumpkin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Spumpkin's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Web前端性能优化——提高页面加载速度</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-18T16:42:52+08:00">
                2018-11-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/11/18/Web前端性能优化——提高页面加载速度/" class="leancloud_visitors" data-flag-title="Web前端性能优化——提高页面加载速度">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">热度 </span>
               
                 <span class="leancloud-visitors-count"></span>
                 <span>℃</span>
             </span>
          

          

          
            <span class="post-meta-divider">|</span>
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                   字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                   分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>前言： </p>
<p>在同样的网络环境下，两个同样能满足你的需求的网站，一个“Duang”的一下就加载出来了，一个纠结了半天才出来，你会选择哪个？研究表明：用户最满意的打开网页时间是2-5秒，如果等待超过10秒，99%的用户会关闭这个网页。也许这样讲，各位还不会有太多感触，接下来我列举一组数据：Google 网站访问速度每慢400ms就导致用户搜索请 求下降0.59%; Amazon 每增加100ms网站延迟将导致收入下降1%;雅虎如果有400ms延迟会导致流量下降5-9%。网站的加载速度严重影响了用户体验，也决定了这个网站的生死存亡。</p>
<p>可能有人会说：网站的性能是后端工程师的事情，与前端并无多大关系。我只能说，too young too simple。事实上，只有10%~20%的最终用户响应时间是用在从 Web 服务器获取 HTML 文档并传送到浏览器的，那剩余的时间去哪儿了？来瞄一下性能黄金法则：</p>
<p>只有10%~20%的最终用户响应时间花在了下载HTML文档上。其余的80%~90%时间花在了下载页面中的所有组件上。</p>
<p>接下来我们将研究一下前端攻城狮如何来提高页面的加载速度。</p>
<h2 id="减少-HTTP-请求"><a href="#减少-HTTP-请求" class="headerlink" title="减少 HTTP 请求"></a>减少 HTTP 请求</h2><p>上面说到80%~90%时间花在了下载页面中的所有组件进行的 HTTP请求上。因此，改善响应时间最简单的途径就是减少 HTTP请求的数量。</p>
<h3 id="图片地图："><a href="#图片地图：" class="headerlink" title="图片地图："></a>图片地图：</h3><p>假设导航栏上有五幅图片，点击每张图片都会进入一个链接，这样五张导航的图片在加载时会产生5个 HTTP 请求。然而，使用一个图片地图可以提高效率，这样就只需要一个 HTTP 请求。</p>
<p><img src="https://images2015.cnblogs.com/blog/861963/201603/861963-20160317164616318-1916945778.png" alt></p>
<p>服务器端图片地图：将所有点击提交到同一个 url，同时提交用户点击的 x、y 坐标，服务器端根据坐标映射响应</p>
<p>客户端图片地图：直接将点击映射到操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=&quot;planets.jpg&quot; border=&quot;0&quot; usemap=&quot;#planetmap&quot; alt=&quot;Planets&quot; /&gt;</span><br><span class="line"></span><br><span class="line">&lt;map name=&quot;planetmap&quot; id=&quot;planetmap&quot;&gt;</span><br><span class="line">     &lt;area shape=&quot;rect&quot; coords=&quot;180,139,14&quot; href =&quot;venus.html&quot; alt=&quot;Venus&quot; /&gt;</span><br><span class="line">     &lt;area shape=&quot;rect&quot; coords=&quot;129,161,10&quot; href =&quot;mercur.html&quot; alt=&quot;Mercury&quot; /&gt;</span><br><span class="line">     &lt;area shape=&quot;rect&quot; coords=&quot;0,0,110,260&quot; href =&quot;sun.html&quot; alt=&quot;Sun&quot; /&gt;</span><br><span class="line">     &lt;area shape=&quot;rect&quot; coords=&quot;140,0,110,260&quot; href =&quot;star.html&quot; alt=&quot;Sun&quot; /&gt;</span><br><span class="line">&lt;/map&gt;</span><br></pre></td></tr></table></figure>
<p>使用图片地图的缺点：指定坐标区域时，矩形或圆形比较容易指定，而其它形状手工指定比较难</p>
<h3 id="CSS-Sprites"><a href="#CSS-Sprites" class="headerlink" title="CSS Sprites"></a>CSS Sprites</h3><p>CSS Sprites 直译过来就是 CSS精灵，但是这种翻译显然是不够的，其实就是通过将多个图片融合到一副图里面，然后通过 CSS 的一些技术布局到网页上。特别是图片特别多的网站，如果能用 CSS Sprites 降低图片数量，带来的将是速度的提升。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;style&gt;</span><br><span class="line">.nav &#123;</span><br><span class="line">    width: 50px;</span><br><span class="line">    height: 50px;</span><br><span class="line">    display: inline-block;</span><br><span class="line">    border: 1px solid #000;</span><br><span class="line">    background-image: url(&apos;E:/1.png&apos;);</span><br><span class="line">&#125;</span><br><span class="line">#image1 &#123;</span><br><span class="line">        background-position: 0 0;</span><br><span class="line">&#125;</span><br><span class="line">#image2 &#123;</span><br><span class="line">        background-position: -95px 0;</span><br><span class="line">&#125;</span><br><span class="line">#image3 &#123;</span><br><span class="line">        background-position: -185px 0;</span><br><span class="line">&#125;</span><br><span class="line">#image4 &#123;</span><br><span class="line">        background-position: -275px 0;</span><br><span class="line">&#125;</span><br><span class="line">#image5 &#123;</span><br><span class="line">        background-position: -366px -3px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;span id=&quot;image1&quot; class=&quot;nav&quot;&gt;&lt;/span&gt;</span><br><span class="line">    &lt;span id=&quot;image2&quot; class=&quot;nav&quot;&gt;&lt;/span&gt;</span><br><span class="line">    &lt;span id=&quot;image3&quot; class=&quot;nav&quot;&gt;&lt;/span&gt;</span><br><span class="line">    &lt;span id=&quot;image4&quot; class=&quot;nav&quot;&gt;&lt;/span&gt;</span><br><span class="line">    &lt;span id=&quot;image5&quot; class=&quot;nav&quot;&gt;&lt;/span&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<p><img src="https://images2015.cnblogs.com/blog/861963/201603/861963-20160317164616318-1916945778.png" alt></p>
<p>PS：使用 CSS Sprites 还有可能降低下载量，可能大家会认为合并后的图片会比分离图片的总和要大，因为还有可能会附加空白区域。实际上，合并后的图片会比分离的图片总和要小，因为它降低了图片自身的开销，譬如颜色表、格式信息等。</p>
<h3 id="字体图标"><a href="#字体图标" class="headerlink" title="字体图标"></a>字体图标</h3><p>在可以大量使用字体图标的地方我们可以尽可能使用字体图标，字体图标可以减少很多图片的使用，从而减少 http 请求，字体图标还可以通过 CSS 来设置颜色、大小等样式，何乐而不为。</p>
<p>合并脚本 和样式表</p>
<p>将多个样式表或者脚本文件合并到一个文件中，可以减少 HTTP 请求的数量从而缩短效应时间。</p>
<p>然而合并所有文件对许多人尤其是编写模块化代码的人来说是不能忍的，而且合并所有的样式文件或者脚本文件可能会导致在一个页面加载时加载了多于自己所需要的样式或者脚本，对于只访问该网站一个（或几个）页面的人来说反而增加了下载量，所以大家应该自己权衡利弊。</p>
<h2 id="使用-CDN"><a href="#使用-CDN" class="headerlink" title="使用 CDN"></a>使用 CDN</h2><p>如果应用程序 Web 服务器离用户更近，那么一个 HTTP请求的响应时间将缩短。另一方面，如果组件 Web 服务器离用户更近，则多个 HTTP请求的响应时间将缩短。</p>
<p>CDN（内容发布网络）是一组分布在多个不同地理位置的 Web 服务器，用于更加有效地向用户发布内容。在优化性能时，向特定用户发布内容的服务器的选择基于对网络慕课拥堵的测量。例如，CDN 可能选择网络阶跃数最小的服务器，或者具有最短响应时间的服务器。</p>
<p>CDN 还可以进行数据备份、扩展存储能力，进行缓存，同时有助于缓和 Web 流量峰值压力。</p>
<p>CDN 的缺点：</p>
<p>1、响应时间可能会受到其他网站流量的影响。CDN 服务提供商在其所有客户之间共享 Web 服务器组。</p>
<p>2、如果 CDN 服务质量下降了，那么你的工作质量也将下降</p>
<p>3、无法直接控制组件服务器</p>
<h2 id="添加-Expires-头"><a href="#添加-Expires-头" class="headerlink" title="添加 Expires 头"></a>添加 Expires 头</h2><p>页面的初次访问者会进行很多 HTTP请求，但是通过使用一个长久的 Expires 头，可以使这些组件被缓存，下次访问的时候，就可以减少不必要的 HTPP请求，从而提高加载速度。</p>
<p>Web 服务器通过 Expires 头告诉客户端可以使用一个组件的当前副本，直到指定的时间为止。例如：</p>
<p>Expires: Fri, 18 Mar 2016 07:41:53 GMT</p>
<p>Expires 缺点： 它要求服务器和客户端时钟严格同步；过期日期需要经常检查</p>
<p>HTTP1.1中引入 Cache-Control 来克服 Expires 头的限制，使用 max-age 指定组件被缓存多久。</p>
<p>Cache-Control： max-age=12345600</p>
<p>若同时制定 Cache-Control 和 Expires，则 max-age 将覆盖 Expires 头</p>
<h2 id="压缩组件"><a href="#压缩组件" class="headerlink" title="压缩组件"></a>压缩组件</h2><p>从 HTTP1.1 开始，Web 客户端可以通过 HTTP 请求中的 Accept-Encoding 头来表示对压缩的支持</p>
<p>Accept-Encoding: gzip,deflate</p>
<p>如果Web服务器看到请求中有这个头，就会使用客户端列出来的方法中的一种来进行压缩。Web 服务器通过响应中的 Content-Encoding 来通知 Web 客户端。</p>
<p>Content-Encoding: gzip</p>
<h3 id="代理缓存"><a href="#代理缓存" class="headerlink" title="代理缓存"></a>代理缓存</h3><p>当浏览器通过代理来发送请求时，情况会不一样。假设针对某个 URL 发送到代理的第一个请求来自于一个不支持 gzip 的浏览器。这是代理的第一个请求，缓存为空。代理将请求转发给服务器。此时响应是未压缩的，代理缓存同时发送给浏览器。现在，假设到达代理的请求是同一个 url，来自于一个支持 gzip 的浏览器。代理会使用缓存中未压缩的内容进行响应，从而失去了压缩的机会。相反，如果第一个浏览器支持 gzip，第二个不支持，你们代理缓存中的压缩版本将会提供给后续的浏览器，而不管它们是否支持 gzip。</p>
<p>解决办法：在web服务器的响应中添加vary头Web服务器可以告诉代理根据一个或多个请求头来改变缓存的响应。因为压缩的决定是基于Accept-Encoding请求头的，因此需要在vary响应头中包含Accept-Encoding。</p>
<p>vary: Accept-Encoding</p>
<h2 id="将样式表放在头部"><a href="#将样式表放在头部" class="headerlink" title="将样式表放在头部"></a>将样式表放在头部</h2><p>首先说明一下，将样式表放在头部对于实际页面加载的时间并不能造成太大影响，但是这会减少页面首屏出现的时间，使页面内容逐步呈现，改善用户体验，防止“白屏”。</p>
<p>我们总是希望页面能够尽快显示内容，为用户提供可视化的回馈，这对网速慢的用户来说是很重要的。</p>
<p>将样式表放在文档底部会阻止浏览器中的内容逐步出现。为了避免当样式变化时重绘页面元素，浏览器会阻塞内容逐步呈现，造成“白屏”。这源自浏览器的行为：如果样式表仍在加载，构建呈现树就是一种浪费，因为所有样式表加载解析完毕之前务虚会之任何东西</p>
<h2 id="将脚本放在底部"><a href="#将脚本放在底部" class="headerlink" title="将脚本放在底部"></a>将脚本放在底部</h2><p>更样式表相同，脚本放在底部对于实际页面加载的时间并不能造成太大影响，但是这会减少页面首屏出现的时间，使页面内容逐步呈现。</p>
<p>js 的下载和执行会阻塞 Dom 树的构建（严谨地说是中断了 Dom 树的更新），所以 script 标签放在首屏范围内的 HTML 代码段里会截断首屏的内容。</p>
<p>下载脚本时并行下载是被禁用的——即使使用了不同的主机名，也不会启用其他的下载。因为脚本可能修改页面内容，因此浏览器会等待；另外，也是为了保证脚本能够按照正确的顺序执行，因为后面的脚本可能与前面的脚本存在依赖关系，不按照顺序执行可能会产生错误。</p>
<h2 id="使用外部的-JavaScript-和-CSS"><a href="#使用外部的-JavaScript-和-CSS" class="headerlink" title="使用外部的 JavaScript 和 CSS"></a>使用外部的 JavaScript 和 CSS</h2><p>内联脚本或者样式可以减少 HTTP 请求，按理来说可以提高页面加载的速度。然而在实际情况中，当脚本或者样式是从外部引入的文件，浏览器就有可能缓存它们，从而在以后加载的时候能够直接使用缓存，而 HTML 文档的大小减小，从而提高加载速度。</p>
<p>影响因素：</p>
<p>1、每个用户产生的页面浏览量越少，内联脚本和样式的论据越强势。譬如一个用户每个月只访问你的网站一两次，那么这种情况下内联将会更好。而如果该用户能够产生很多页面浏览量，那么缓存的样式和脚本将会极大减少下载的时间，提交页面加载速度。</p>
<p>2、如果你的网站不同的页面之间使用的组件大致相同，那么使用外部文件可以提高这些组件的重用率。</p>
<h3 id="加载后下载"><a href="#加载后下载" class="headerlink" title="加载后下载"></a>加载后下载</h3><p>有时候我们希望内联样式和脚本，但又可以为接下来的页面提供外部文件。那么我们可以在页面加载完成后动态加载外部组件，以便用户接下来的访问。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">function doOnload() &#123;</span><br><span class="line">    setTimeout(&quot;downloadFile()&quot;,1000);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">window.onload = doOnload;</span><br><span class="line"></span><br><span class="line">function downloadFile() &#123;</span><br><span class="line">    downloadCss(&quot;http://abc.com/css/a.css&quot;);</span><br><span class="line">    downloadJS(&quot;http://abc.com/js/a.js&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function downloadCss(url) &#123;</span><br><span class="line">    var ele = document.createElement(&apos;link&apos;);</span><br><span class="line">    ele.rel = &quot;stylesheet&quot;;</span><br><span class="line">    ele.type = &quot;text/css&quot;;</span><br><span class="line">    ele.href = url;</span><br><span class="line"></span><br><span class="line">    document.body.appendChild(ele);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function downloadJS(url) &#123;</span><br><span class="line">    var ele = document.createElement(&apos;script&apos;);</span><br><span class="line">    ele.src = url;</span><br><span class="line">    document.body.appendChild(ele);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在该页面中，JavaScript 和 CSS 被加载两次（内联和外部）。要使其正常工作，必须处理双重定义。将这些组件放到一个不可见的 IFrame 中是一个比较好的解决方式。</p>
<h2 id="减少DNS查找"><a href="#减少DNS查找" class="headerlink" title="减少DNS查找"></a>减少DNS查找</h2><p>当我们在浏览器的地址栏输入网址（譬如： <a href="http://www.linux178.com）" target="_blank" rel="noopener">www.linux178.com）</a> ，然后回车，回车这一瞬间到看到页面到底发生了什么呢？</p>
<p>域名解析 –&gt; 发起 TCP 的 3 次握手 –&gt; 建立 TCP 连接后发起 http 请求 –&gt; 服务器响应 http 请求，浏览器得到 html 代码 –&gt; 浏览器解析 html 代码，并请求 html 代码中的资源（如js、css、图片等） –&gt; 浏览器对页面进行渲染呈现给用户</p>
<p>域名解析是页面加载的第一步，那么域名是如何解析的呢？以 Chrome 为例：</p>
<p>1.Chrome 浏览器 会首先搜索浏览器自身的 DNS缓存（缓存时间比较短，大概只有1分钟，且只能容纳1000条缓存），看自身的缓存中是否有 <a href="http://www.linux178.com" target="_blank" rel="noopener">www.linux178.com</a> 对应的条目，而且没有过期，如果有且没有过期则解析到此结束。<br>注：我们怎么查看 Chrome 自身的缓存？可以使用 chrome://net-internals/#dns 来进行查看</p>
<p>2.如果浏览器自身的缓存里面没有找到对应的条目，那么 Chrome 会搜索操作系统自身的 DNS 缓存,如果找到且没有过期则停止搜索解析到此结束.<br>注：怎么查看操作系统自身的 DNS 缓存，以 Windows 系统为例，可以在命令行下使用 ipconfig /displaydns 来进行查看 </p>
<p>3.如果在 Windows 系统的 DNS 缓存也没有找到，那么尝试读取 hosts 文件（位于C:\Windows\System32\drivers\etc），看看这里面有没有该域名对应的 IP 地址，如果有则解析成功。</p>
<p>4.如果在 hosts 文件中也没有找到对应的条目，浏览器就会发起一个 DNS 的系统调用，就会向本地配置的首选 DNS 服务器（一般是电信运营商提供的，也可以使用像 Google 提供的 DNS 服务器）发起域名解析请求（通过的是 UDP 协议向 DNS 的 53 端口发起请求，这个请求是递归的请求，也就是运营商的 DNS 服务器必须得提供给我们该域名的 IP 地址），运营商的 DNS 服务器首先查找自身的缓存，找到对应的条目，且没有过期，则解析成功。如果没有找到对应的条目，则有运营商的 DNS 代我们的浏览器发起迭代 DNS 解析请求，它首先是会找根域的 DNS 的 IP 地址（这个 DNS 服务器都内置 13 台根域的 DNS 的 I P地址），找打根域的 DNS 地址，就会向其发起请求（请问 <a href="http://www.linux178.com" target="_blank" rel="noopener">www.linux178.com</a> 这个域名的 IP 地址是多少啊？），根域发现这是一个顶级域 com 域的一个域名，于是就告诉运营商的 DNS 我不知道这个域名的 IP 地址，但是我知道 com 域的 IP 地址，你去找它去，于是运营商的 DNS 就得到了com 域的 IP 地址，又向 com 域的 IP 地址发起了请求（请问 <a href="http://www.linux178.com" target="_blank" rel="noopener">www.linux178.com</a> 这个域名的 IP 地址是多少?）,com 域这台服务器告诉运营商的 DNS 我不知道 <a href="http://www.linux178.com" target="_blank" rel="noopener">www.linux178.com</a> 这个域名的 IP 地址，但是我知道 linux178.com 这个域的 DNS 地址，你去找它去，于是运营商的 DNS 又向 linux178.com 这个域名的 DNS 地址（这个一般就是由域名注册商提供的，像万网，新网等）发起请求（请问 <a href="http://www.linux178.com" target="_blank" rel="noopener">www.linux178.com</a> 这个域名的 IP 地址是多少？），这个时候 linux178.com 域的 DNS 服务器一查，诶，果真在我这里，于是就把找到的结果发送给运营商的 DNS 服务器，这个时候运营商的 DNS 服务器就拿到了 <a href="http://www.linux178.com" target="_blank" rel="noopener">www.linux178.com</a> 这个域名对应的 IP 地址，并返回给 Windows 系统内核，内核又把结果返回给浏览器，终于浏览器拿到了 <a href="http://www.linux178.com" target="_blank" rel="noopener">www.linux178.com</a> 对应的 IP 地址，该进行一步的动作了。</p>
<p>注：一般情况下是不会进行以下步骤的</p>
<p>如果经过以上的4个步骤，还没有解析成功，那么会进行如下步骤：<br>5.操作系统就会查找 NetBIOS name Cache（NetBIOS 名称缓存，就存在客户端电脑中的），那这个缓存有什么东西呢？凡是最近一段时间内和我成功通讯的计算机的计算机名和 IP 地址，就都会存在这个缓存里面。什么情况下该步能解析成功呢？就是该名称正好是几分钟前和我成功通信过，那么这一步就可以成功解析。</p>
<p>6.如果第5步也没有成功，那会查询 WINS 服务器（是 NETBIOS 名称和 IP 地址对应的服务器）</p>
<p>7.如果第6步也没有查询成功，那么客户端就要进行广播查找</p>
<p>8.如果第7步也没有成功，那么客户端就读取 LMHOSTS 文件（和 HOSTS 文件同一个目录下，写法也一样）</p>
<p>如果第八步还没有解析成功，那么就宣告这次解析失败，那就无法跟目标计算机进行通信。只要这八步中有一步可以解析成功，那就可以成功和目标计算机进行通信。</p>
<p>DNS 也是开销，通常浏览器查找一个给定域名的 IP 地址要花费20~120毫秒，在完成域名解析之前，浏览器不能从服务器加载到任何东西。那么如何减少域名解析时间，加快页面加载速度呢？</p>
<p>当客户端 DNS 缓存（浏览器和操作系统）缓存为空时，DNS 查找的数量与要加载的 Web 页面中唯一主机名的数量相同，包括页面 URL、脚本、样式表、图片、Flash 对象等的主机名。减少主机名的 数量就可以减少 DNS 查找的数量。</p>
<p>减少唯一主机名的数量会潜在减少页面中并行下载的数量（HTTP 1.1 规范建议从每个主机名并行下载两个组件，但实际上可以多个），这样减少主机名和并行下载的方案会产生矛盾，需要大家自己权衡。建议将组件放到至少两个但不多于4个主机名下，减少 DNS 查找的同时也允许高度并行下载。</p>
<h2 id="精简-JavaScript"><a href="#精简-JavaScript" class="headerlink" title="精简 JavaScript"></a>精简 JavaScript</h2><h3 id="精简"><a href="#精简" class="headerlink" title="精简"></a>精简</h3><p>精简就是从代码中移除不必要的字符以减少文件大小，降低加载的时间。代码精简的时候会移除不必要的空白字符（空格，换行、制表符），这样整个文件的大小就变小了。</p>
<h3 id="混淆"><a href="#混淆" class="headerlink" title="混淆"></a>混淆</h3><p>混淆是应用在源代码上的另外一种方式，它会移除注释和空白符，同时它还会改写代码。在混淆的时候，函数和变量名将会被转换成更短的字符串，这时代码会更加精炼同时难以阅读。通常这样做是为了增加对代码进行反向工程的难度，这也同时提高了性能。</p>
<p>缺点：</p>
<p>混淆本身比较复杂，可能会引入错误。</p>
<p>需要对不能改变的符号做标记，防止 JavaScript 符号（譬如关键字、保留字）被修改。</p>
<p>混淆会使代码难以阅读，这使得在产品环境中调试问题更加困难。</p>
<p>在以上提到了关于用 gzip 之类的压缩方式来压缩文件，这边说明一下，就算使用 gzip 等方式来压缩文件，精简代码依然是有必要的。一般来说，压缩产生的节省是高于精简的，在生产环境中，精简和压缩同时使用能够最大限度的获得更多的节省。</p>
<h2 id="CSS-的精简"><a href="#CSS-的精简" class="headerlink" title="CSS 的精简"></a>CSS 的精简</h2><p>CSS的精简带来的节省一般来说是小于JavaScript精简的，因为CSS中注释和空白相对较少。</p>
<p>除了移除空白、注释之外，CSS可以通过优化来获得更多的节省：</p>
<p>合并相同的类；</p>
<p>移除不使用的类；</p>
<p>使用缩写，譬如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">.right &#123;</span><br><span class="line">    color: #fff;</span><br><span class="line"></span><br><span class="line">    padding-top: 0; </span><br><span class="line"></span><br><span class="line">    margin: 0 10px;</span><br><span class="line">    </span><br><span class="line">    border: 1px solid #111</span><br><span class="line">&#125;</span><br><span class="line">.wrong &#123;</span><br><span class="line">    color: #ffffff;</span><br><span class="line"></span><br><span class="line">    padding-top: 0px; </span><br><span class="line"></span><br><span class="line">    margin-top: 0;</span><br><span class="line">    margin-bottom: 0;</span><br><span class="line">    margin-left: 10px;</span><br><span class="line">    margin-right: 10px;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    border-color: #111;</span><br><span class="line">    border-width: 1px;</span><br><span class="line">    border-style: solid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="避免重定向"><a href="#避免重定向" class="headerlink" title="避免重定向"></a>避免重定向</h2><h3 id="什么是重定向？"><a href="#什么是重定向？" class="headerlink" title="什么是重定向？"></a>什么是重定向？</h3><p>重定向用于将用户从一个URL重新路由到另一个URL。</p>
<h3 id="常用重定向的类型"><a href="#常用重定向的类型" class="headerlink" title="常用重定向的类型"></a>常用重定向的类型</h3><p>301：永久重定向，主要用于当网站的域名发生变更之后，告诉搜索引擎域名已经变更了，应该把旧域名的的数据和链接数转移到新域名下，从而不会让网站的排名因域名变更而受到影响。</p>
<p>302：临时重定向，主要实现 post 请求后告知浏览器转移到新的 URL。</p>
<p>304：Not Modified，主要用于当浏览器在其缓存中保留了组件的一个副本，同时组件已经过期了，这是浏览器就会生成一个条件 GET 请求，如果服务器的组件并没有修改过，则会返回 304 状态码，同时不携带主体，告知浏览器可以重用这个副本，减少响应大小。</p>
<h3 id="重定向如何损伤性能？"><a href="#重定向如何损伤性能？" class="headerlink" title="重定向如何损伤性能？"></a>重定向如何损伤性能？</h3><p>当页面发生了重定向，就会延迟整个 HTML 文档的传输。在 HTML 文档到达之前，页面中不会呈现任何东西，也没有任何组件会被下载。</p>
<p>来看一个实际例子：对于 ASP.NET webform 开发来说，对于新手很容易犯一个错误，就是把页面的连接写成服务器控件后台代码里，例如用一个 Button 控件，在它的后台 click 事件中写上：Response.Redirect(“”)；然而这个 Button 的作用只是转移 URL，这是非常低效的做法，因为点击 Button 后，先发送一个 Post 请求给服务器，服务器处理Response.Redirect(“”) 后就发送一个 302 响应给浏览器，浏览器再根据响应的 URL 发送 GET 请求。正确的做法应该是在 html 页面直接使用 a 标签做链接，这样就避免了多余的 post 和重定向。</p>
<h3 id="重定向的应用场景"><a href="#重定向的应用场景" class="headerlink" title="重定向的应用场景"></a>重定向的应用场景</h3><h4 id="跟踪内部流量"><a href="#跟踪内部流量" class="headerlink" title="跟踪内部流量"></a>跟踪内部流量</h4><p>重定向经常用于跟踪用户流量的方向,当拥有一个门户主页的时候，同时想对用户离开主页后的流量进行跟踪，这时可以使用重定向。例如: 某网站主页新闻的链接地址<a href="http://a.com/r/news，点击该链接将产生" target="_blank" rel="noopener">http://a.com/r/news，点击该链接将产生</a> 301 响应，其 Location 被设置为 <a href="http://news.a.com。通过分析" target="_blank" rel="noopener">http://news.a.com。通过分析</a> a.com 的 web 服务器日志可以得知人们离开首页之后的去向。</p>
<p>我们知道重定向是如何损伤性能的，为了实现更好的效率，可以使用 Referer 日志来跟踪内部流量去向。每个 HTTP 请求都有一个 Referer 表示原始请求页(除了从书签打开或直接键入 URL 等操作)，记录下每个请求的 Referer，就避免了向用户发送重定向，从而改善了响应时间。</p>
<h4 id="跟踪出站流量"><a href="#跟踪出站流量" class="headerlink" title="跟踪出站流量"></a>跟踪出站流量</h4><p>有时链接可能将用户带离你的网站，在这种情况下，使用Referer就不太现实了。</p>
<p>同样也可以使用重定向来解决跟踪出站流量问题。以百度搜索为例，百度通过将每个链接包装到一个302重定向来解决跟踪的问题，例如搜索关键字“前端性能优化”，搜索结果中的一个 URL 为 <a href="https://www.baidu.com/link?url=pDjwTfa0IAf_FRBNlw1qLDtQ27YBujWp9jPN4q0QSJdNtGtDBK3ja3jyyN2CgxR5aTAywG4SI6V1NypkSyLISWjiFuFQDinhpVn4QE-uLGG&amp;wd=&amp;eqid=9c02bd21001c69170000000556ece297，即使搜索结果并没有变，但这个字符串是动态改变的，暂时还不知道这里起到怎样的作用？（个人感觉：字符串中包含了待访问的网址，点击之后会产生" target="_blank" rel="noopener">https://www.baidu.com/link?url=pDjwTfa0IAf_FRBNlw1qLDtQ27YBujWp9jPN4q0QSJdNtGtDBK3ja3jyyN2CgxR5aTAywG4SI6V1NypkSyLISWjiFuFQDinhpVn4QE-uLGG&amp;wd=&amp;eqid=9c02bd21001c69170000000556ece297，即使搜索结果并没有变，但这个字符串是动态改变的，暂时还不知道这里起到怎样的作用？（个人感觉：字符串中包含了待访问的网址，点击之后会产生</a> 302 重定向，将页面转到目标页面（待修改，求大神们给我指正））</p>
<p>除了重定向外，我们还可以选择使用信标(beacon)——一个 HTTP 请求，其 URL 中包含有跟踪信息。跟踪信息可以从信标 Web 服务器的访问日记中提取出来，信标通常是一个 1px*1px 的透明图片，不过 304 响应更优秀，因为它更小，从来不被缓存，而且绝不会改变浏览器的状态。</p>
<h2 id="删除重复脚本"><a href="#删除重复脚本" class="headerlink" title="删除重复脚本"></a>删除重复脚本</h2><p>在团队开发一个项目时，由于不同开发者之间都可能会向页面中添加页面或组件，因此可能相同的脚本会被添加多次。</p>
<p>重复的脚本会造成不必要的 HTTP 请求（如果没有缓存该脚本的话），并且执行多余的 JavaScript 浪费时间，还有可能造成错误。</p>
<p>如何避免重复脚本呢？</p>
<p>1.形成良好的脚本组织。重复脚本有可能出现在不同的脚本包含同一段脚本的情况，有些是必要的，但有些却不是必要的，所以需要对脚本进行一个良好的组织。</p>
<p>2.实现脚本管理器模块。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">function insertScript($file) &#123;</span><br><span class="line">     if(hadInserted($file)) &#123;</span><br><span class="line">          return;</span><br><span class="line">      &#125;</span><br><span class="line">      exeInsert($file);</span><br><span class="line">  </span><br><span class="line">      if(hasDependencies($file)) &#123;</span><br><span class="line">  </span><br><span class="line">          $deps = getDependencies($file);</span><br><span class="line"> </span><br><span class="line">         foreach ($deps as $script) &#123;</span><br><span class="line">             insertScript($script);</span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">         echo &quot;&lt;script type=&apos;text/javascript&apos; src=&apos;&quot;.getVersion($file).&quot;&apos;&gt;&lt;/script&gt;&quot;;</span><br><span class="line"> </span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>先检查是否插入过，如果插入过则返回。如果该脚本依赖其它脚本，则被依赖的脚本也会被插入。最后脚本被传送到页面，getVersion 会检查脚本并返回追加了对应版本号的文件名，这样如果脚本的版本变化了，那么以前浏览器缓存的就会失效。</p>
<h2 id="配置-ETag"><a href="#配置-ETag" class="headerlink" title="配置 ETag"></a>配置 ETag</h2><p>以前浏览器缓存的就会失效。</p>
<h3 id="什么是-ETag？"><a href="#什么是-ETag？" class="headerlink" title="什么是 ETag？"></a>什么是 ETag？</h3><p>实体标签(EntityTag)是唯一标识了一个组件的一个特定版本的字符串，是 web 服务器用于确认缓存组件的有效性的一种机制，通常可以使用组件的某些属性来构造它。</p>
<h3 id="条件-GET-请求"><a href="#条件-GET-请求" class="headerlink" title="条件 GET 请求"></a>条件 GET 请求</h3><p>如果组件过期了，浏览器在重用它之前必须首先检查它是否有效。浏览器将发送一个条件 GET 请求到服务器，服务器判断缓存还有效，则发送一个 304 响应，告诉浏览器可以重用缓存组件。</p>
<p>那么服务器是根据什么判断缓存是否还有效呢?有两种方式：ETag（实体标签）和 最新修改日期。</p>
<h4 id="最新修改日期"><a href="#最新修改日期" class="headerlink" title="最新修改日期"></a>最新修改日期</h4><p>原始服务器通过 Last-Modified 响应头来返回组件的最新修改日期。</p>
<p>举个栗子：</p>
<p>当我们不带缓存访问 <a href="http://www.google.com.hk" target="_blank" rel="noopener">www.google.com.hk</a> 的时候，我们需要下载 google 的 logo，这时会发送这样一个 HTTP 请求：</p>
<p>Requset：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET googlelogo_color_272x92dp.png HTTP 1.1</span><br><span class="line"></span><br><span class="line">Host: www.google.com.hk</span><br></pre></td></tr></table></figure></p>
<p>Respone：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HTTP 1.1 200 OK</span><br><span class="line"></span><br><span class="line">Last-Modified:Fri, 04 Sep 2015 22:33:08 GMT</span><br></pre></td></tr></table></figure></p>
<p><img src="https://images2015.cnblogs.com/blog/861963/201603/861963-20160319143807209-1678450570.png" alt></p>
<p>当需要再次访问相同组件的时候，同时缓存已经过期，浏览器会发送如下条件GET请求：</p>
<p>Request：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET googlelogo_color_272x92dp.png HTTP 1.1</span><br><span class="line"></span><br><span class="line">If-Modified-Since:Fri, 04 Sep 2015 22:33:08 GMT</span><br><span class="line"></span><br><span class="line">Host: www.google.com.hk</span><br></pre></td></tr></table></figure></p>
<p>Response：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HTTP 1.1 304 Not Modified</span><br></pre></td></tr></table></figure></p>
<p><img src="https://images2015.cnblogs.com/blog/861963/201603/861963-20160319143556756-1561871554.png" alt></p>
<h4 id="实体标签"><a href="#实体标签" class="headerlink" title="实体标签"></a>实体标签</h4><p>ETag 提供了另外一种方式，用于检测浏览器缓存中的组件与原始服务器上的组件是否匹配。摘抄自书上的例子：</p>
<p>不带缓存的请求：</p>
<p>Request：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /i/yahoo/gif HTTP 1.1</span><br><span class="line"></span><br><span class="line">Host: us.yimg.com</span><br></pre></td></tr></table></figure></p>
<p>Response:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET /i/yahoo/gif HTTP 1.1</span><br><span class="line"></span><br><span class="line">Host: us.yimg.com</span><br><span class="line"></span><br><span class="line">If-Modified-Since:Tue,12 Dec 200603:03:59 GMT</span><br><span class="line"></span><br><span class="line">If-None-Match:”10c24bc-4ab-457elc1f“</span><br></pre></td></tr></table></figure></p>
<p>再次请求相同组件:</p>
<p>Request：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET /i/yahoo/gif HTTP 1.1</span><br><span class="line"></span><br><span class="line">Host: us.yimg.com</span><br><span class="line"></span><br><span class="line">If-Modified-Since:Tue,12 Dec 200603:03:59 GMT</span><br><span class="line"></span><br><span class="line">If-None-Match:“10c24bc-4ab-457elc1f”</span><br></pre></td></tr></table></figure></p>
<p>Response：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HTTP 1.1 304 Not Midified</span><br></pre></td></tr></table></figure></p>
<h3 id="为什么要引入-ETag？"><a href="#为什么要引入-ETag？" class="headerlink" title="为什么要引入 ETag？"></a>为什么要引入 ETag？</h3><p>ETag 主要是为了解决 Last-Modified 无法解决的一些问题：</p>
<p>1.一些文件也许会周期性的更改，但是他的内容并不改变(仅仅改变的修改时间)，这个时候我们并不希望客户端认为这个文件被修改了，而重新 GET;</p>
<p>2.某些文件修改非常频繁，比如在秒以下的时间内进行修改，(比方说 1s 内修改了 N 次)，If-Modified-Since 能检查到的粒度是 s 级的，这种修改无法判断(或者说 UNIX 记录 MTIME 只能精确到秒);</p>
<p>3.某些服务器不能精确的得到文件的最后修改时间。</p>
<h3 id="ETag带来的问题"><a href="#ETag带来的问题" class="headerlink" title="ETag带来的问题"></a>ETag带来的问题</h3><p>ETag 的问题在于通常使用某些属性来构造它，有些属性对于特定的部署了网站的服务器来说是唯一的。当使用集群服务器的时候，浏览器从一台服务器上获取了原始组件，之后又向另外一台不同的服务器发起条件 GET 请求，ETag 就会出现不匹配的状况。例如：使用 inode-size-timestamp 来生成 ETag，文件系统使用 inode 存储文件类型、所有者、组和访问模式等信息，在多台服务器上，就算文件大小、权限、时间戳等都相同，inode 也是不同的。</p>
<h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><p>1.如果使用 Last-Modified 不会出现任何问题，可以直接移除 ETag，google 的搜索首页则没有使用 ETag。</p>
<p>2.确定要使用 ETag，在配置 ETag 的值的时候，移除可能影响到组件集群服务器验证的属性，例如使用 size-timestamp 来生成时间戳。</p>
<h2 id="使-Ajax-可缓存"><a href="#使-Ajax-可缓存" class="headerlink" title="使 Ajax 可缓存"></a>使 Ajax 可缓存</h2><p>维基百科中这样定义Ajax：</p>
<p>JAX即“Asynchronous JavaScript and XML”（异步的JavaScript与XML技术），指的是一套综合了多项技术的浏览器端网页开发技术。Ajax的概念由杰西·詹姆士·贾瑞特所提出。</p>
<p>传统的Web应用允许用户端填写表单（form），当提交表单时就向Web服务器发送一个请求。服务器接收并处理传来的表单，然后送回一个新的网页，但这个做法浪费了许多带宽，因为在前后两个页面中的大部分HTML码往往是相同的。由于每次应用的沟通都需要向服务器发送请求，应用的回应时间依赖于服务器的回应时间。这导致了用户界面的回应比本机应用慢得多。</p>
<p>与此不同，AJAX应用可以仅向服务器发送并取回必须的数据，并在客户端采用JavaScript处理来自服务器的回应。因为在服务器和浏览器之间交换的数据大量减少（大约只有原来的5%）[来源请求],服务器回应更快了。同时，很多的处理工作可以在发出请求的客户端机器上完成，因此Web服务器的负荷也减少了。</p>
<p>类似于DHTML或LAMP，AJAX不是指一种单一的技术，而是有机地利用了一系列相关的技术。虽然其名称包含XML，但实际上数据格式可以由JSON代替，进一步减少数据量，形成所谓的AJAJ。而客户端与服务器也并不需要异步。一些基于AJAX的“派生／合成”式（derivative/composite）的技术也正在出现，如AFLAX。</p>
<p>Ajax的目地是为突破web本质的开始—停止交互方式，向用户显示一个白屏后重绘整个页面不是一种好的用户体验。</p>
<h3 id="异步与即时"><a href="#异步与即时" class="headerlink" title="异步与即时"></a>异步与即时</h3><p>Ajax的一个明显的有点就是向用户提供了即时反馈，因为它异步的从后端web服务器请求信息。</p>
<p>用户是否需要等待的关键因素在于Ajax请求是被动的还是主动的。被动请求是为了将来来使用而预先发起的，主动请求是基于用户当前的操作而发起的</p>
<h3 id="什么样的-AJAX-请求可以被缓存？"><a href="#什么样的-AJAX-请求可以被缓存？" class="headerlink" title="什么样的 AJAX 请求可以被缓存？"></a>什么样的 AJAX 请求可以被缓存？</h3><p>POST 的请求，是不可以在客户端缓存的，每次请求都需要发送给服务器进行处理，每次都会返回状态码 200。（可以在服务器端对数据进行缓存，以便提高处理速度）</p>
<p>GET 的请求，是可以（而且默认）在客户端进行缓存的，除非指定了不同的地址，否则同一个地址的 AJAX 请求，不会重复在服务器执行，而是返回 304。</p>
<h3 id="Ajax-请求使用缓存"><a href="#Ajax-请求使用缓存" class="headerlink" title="Ajax 请求使用缓存"></a>Ajax 请求使用缓存</h3><p>在进行 Ajax 请求的时候，可以选择尽量使用 get 方法，这样可以使用客户端的缓存，提高请求速度。</p>
<p>本文转载至：<a href="http://www.cnblogs.com/MarcoHan/" target="_blank" rel="noopener">http://www.cnblogs.com/MarcoHan/</a> </p>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/11/16/HTML知识点/" rel="next" title="HTML知识点">
                <i class="fa fa-chevron-left"></i> HTML知识点
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/03/03/hello-world/" rel="prev" title="Hello World">
                Hello World <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zODQ0Ny8xNDk3NQ=="></div>
    
 
  </div>



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/uploads/head.jpg" alt="Spumpkin">
          <p class="site-author-name" itemprop="name">Spumpkin</p>
           
              <p class="site-description motion-element" itemprop="description">个人技术博客</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">44</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/archives/index.html">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#减少-HTTP-请求"><span class="nav-number">1.</span> <span class="nav-text">减少 HTTP 请求</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#图片地图："><span class="nav-number">1.1.</span> <span class="nav-text">图片地图：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSS-Sprites"><span class="nav-number">1.2.</span> <span class="nav-text">CSS Sprites</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#字体图标"><span class="nav-number">1.3.</span> <span class="nav-text">字体图标</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用-CDN"><span class="nav-number">2.</span> <span class="nav-text">使用 CDN</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加-Expires-头"><span class="nav-number">3.</span> <span class="nav-text">添加 Expires 头</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#压缩组件"><span class="nav-number">4.</span> <span class="nav-text">压缩组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#代理缓存"><span class="nav-number">4.1.</span> <span class="nav-text">代理缓存</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#将样式表放在头部"><span class="nav-number">5.</span> <span class="nav-text">将样式表放在头部</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#将脚本放在底部"><span class="nav-number">6.</span> <span class="nav-text">将脚本放在底部</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用外部的-JavaScript-和-CSS"><span class="nav-number">7.</span> <span class="nav-text">使用外部的 JavaScript 和 CSS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#加载后下载"><span class="nav-number">7.1.</span> <span class="nav-text">加载后下载</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#减少DNS查找"><span class="nav-number">8.</span> <span class="nav-text">减少DNS查找</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#精简-JavaScript"><span class="nav-number">9.</span> <span class="nav-text">精简 JavaScript</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#精简"><span class="nav-number">9.1.</span> <span class="nav-text">精简</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#混淆"><span class="nav-number">9.2.</span> <span class="nav-text">混淆</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CSS-的精简"><span class="nav-number">10.</span> <span class="nav-text">CSS 的精简</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#避免重定向"><span class="nav-number">11.</span> <span class="nav-text">避免重定向</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是重定向？"><span class="nav-number">11.1.</span> <span class="nav-text">什么是重定向？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常用重定向的类型"><span class="nav-number">11.2.</span> <span class="nav-text">常用重定向的类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重定向如何损伤性能？"><span class="nav-number">11.3.</span> <span class="nav-text">重定向如何损伤性能？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重定向的应用场景"><span class="nav-number">11.4.</span> <span class="nav-text">重定向的应用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#跟踪内部流量"><span class="nav-number">11.4.1.</span> <span class="nav-text">跟踪内部流量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#跟踪出站流量"><span class="nav-number">11.4.2.</span> <span class="nav-text">跟踪出站流量</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#删除重复脚本"><span class="nav-number">12.</span> <span class="nav-text">删除重复脚本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置-ETag"><span class="nav-number">13.</span> <span class="nav-text">配置 ETag</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是-ETag？"><span class="nav-number">13.1.</span> <span class="nav-text">什么是 ETag？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#条件-GET-请求"><span class="nav-number">13.2.</span> <span class="nav-text">条件 GET 请求</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#最新修改日期"><span class="nav-number">13.2.1.</span> <span class="nav-text">最新修改日期</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实体标签"><span class="nav-number">13.2.2.</span> <span class="nav-text">实体标签</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么要引入-ETag？"><span class="nav-number">13.3.</span> <span class="nav-text">为什么要引入 ETag？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ETag带来的问题"><span class="nav-number">13.4.</span> <span class="nav-text">ETag带来的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#最佳实践"><span class="nav-number">13.5.</span> <span class="nav-text">最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使-Ajax-可缓存"><span class="nav-number">14.</span> <span class="nav-text">使 Ajax 可缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#异步与即时"><span class="nav-number">14.1.</span> <span class="nav-text">异步与即时</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#什么样的-AJAX-请求可以被缓存？"><span class="nav-number">14.2.</span> <span class="nav-text">什么样的 AJAX 请求可以被缓存？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ajax-请求使用缓存"><span class="nav-number">14.3.</span> <span class="nav-text">Ajax 请求使用缓存</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Spumpkin</span>
</div>



<div class="powered-by">
<i class="fa fa-user-md"></i>
<span id="busuanzi_container_site_uv">
  访问用户:<span id="busuanzi_value_site_uv"></span>
  <div class="powered-by"></div>
<i class="fa fa-eye"></i>
<span id="busuanzi_container_site_pv">
  访问量:<span id="busuanzi_value_site_pv"></span>次
</span>
</span></div>

<div class="theme-info">
  <i class="fa fa-file-word-o"></i>
  <span class="post-count">全站共  字</span>
</div>



        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("OmrzeBPrdmOT99EHk3FK8HSE-gzGzoHsz", "nAITf6GVREXfSDVLJXWBijtN");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
